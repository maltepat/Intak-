<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TXL Guide</title>
<style>
  :root { --pad: 16px; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, sans-serif; background:#f7f7f8; }

  /* Header */
  .topbar { position:sticky; top:0; z-index:5; display:flex; gap:12px;
    align-items:center; padding:12px var(--pad); background:#fff; border-bottom:1px solid #e6e6e8; }
  .title { font-weight:700; font-size:18px; }
  .lang { margin-left:auto; }

  /* Tabs */
  .tabs { position:sticky; top:56px; z-index:4; display:flex; gap:8px; padding:8px var(--pad);
    background:#fff; border-bottom:1px solid #eee; }
  .tab { flex:1; text-align:center; padding:10px; border-radius:10px; background:#f0f0f2; cursor:pointer; }
  .tab.active { background:#111; color:#fff; }

  /* Kategorie-Chips */
  .chips { display:flex; gap:8px; overflow:auto; padding:10px var(--pad); }
  .chip { white-space:nowrap; padding:8px 12px; border-radius:999px; background:#fff; border:1px solid #e5e5e7; cursor:pointer; }

  /* Liste */
  .list { padding:12px var(--pad) 80px; display:grid; gap:12px; }
  .card { background:#fff; border:1px solid #eee; border-radius:14px; padding:14px; display:grid; grid-template-columns:52px 1fr; gap:12px; }
  .card h3 { margin:0 0 6px; font-size:16px; }
  .meta { color:#555; font-size:13px; }
  .actions { margin-top:8px; display:flex; gap:8px; }
  .btn { padding:10px 12px; border-radius:10px; background:#111; color:#fff; font-size:14px; border:none; cursor:pointer; }
  .btn.ghost { background:#fff; color:#111; border:1px solid #ddd; }
/* Karte */
.mapwrap {
  display:none;
  height:calc(100vh - 112px);
  overflow:hidden;
  position:relative;
  background:#000;
  touch-action:none;
  overscroll-behavior: contain;
}
.mapwrap.active { display:block; }

.map {
  position:relative;
  width:1920px;
  height:1080px;
  touch-action:none;
  will-change: transform;
  transform-origin: 0 0 !important;  /* ðŸ‘ˆ Anker oben/links â€“ wichtig fÃ¼r korrektes pan/zoom */
}

.map-img {
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit: contain;     
  display:block;
  user-select:none;
  pointer-events:none;
}


.pin {
  position: absolute;
  /* deine bisherige BoxgrÃ¶ÃŸe in % bleibt gleich */
  width: 3.05%;
  height: auto;
  cursor: pointer;

  /* Bild in der Box zentrieren */
  display: flex;
  align-items: center;
  justify-content: center;

  /* weiterhin KEIN translate, weil getPinCenter die Box-Mitte berechnet */
  transform: none;
  transform-origin: center center;
}

.pin img {
  width: 70%;   /* ðŸ‘ˆ wieder wie vorher */
  height: auto;
  pointer-events: none;
}



  /* Pin-Highlight */
.pin { transform-origin: center center; } /* wichtig, damit Scale nicht verrutscht */
.pin.highlight { z-index: 6; transform: scale(1.25); }
.pin.highlight img {
  filter: drop-shadow(0 0 10px rgba(255, 210, 0, 0.95));
  animation: pinPulse 1.2s ease-in-out infinite;
}
@keyframes pinPulse {
  0%, 100% { transform: scale(1); }
  50%      { transform: scale(1.08); }
}

/* (optional) ausgewÃ¤hlte Karte in der Liste visuell markieren */
.card.selected {
  border-color: #111;
  box-shadow: 0 0 0 2px #111 inset;
}

  /* Bottom Sheet */
  .sheet { position:fixed; left:0; right:0; bottom:-100%; background:#fff; border-radius:16px 16px 0 0;
    box-shadow:0 -10px 30px rgba(0,0,0,.2); padding:16px; transition:bottom .25s ease; z-index:10; max-height:70vh; overflow:auto; }
  .sheet.open { bottom:0; }
  .sheet h3 { margin:0 0 8px; }
  .sheet .meta { margin-bottom:10px; }
  .sheet .close { position:absolute; right:12px; top:12px; font-size:20px; border:none; background:transparent; cursor:pointer; }

  /* Mobile: Vollbild-Karte */
  @media (max-width: 768px) {
    body.fullscreen-map .topbar,
    body.fullscreen-map .tabs,
    body.fullscreen-map .chips { display:none; }

    body.fullscreen-map { overflow:hidden; }

body.fullscreen-map .mapwrap {
      position: fixed;
      inset: 0;
      z-index: 9999;
      width: 100vw;
      height: calc(var(--vh, 1vh) * 100); /* kommt aus JS */
      display: block !important;
      background: #000;
      touch-action: none;
      overscroll-behavior: contain;
    }

    .exit-fullscreen {
      position: fixed;
      z-index: 10000;
      right: 12px; top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #333;
      background: rgba(255,255,255,.9);
      font-weight: 600;
    }
    body:not(.fullscreen-map) .exit-fullscreen { display:none; }
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="title">TXL Guide</div>
    <select class="lang" id="lang" onchange="setLang(this.value)">
      <option value="de">DE</option><option value="en">EN</option>
      <option value="tr">TR</option><option value="uk">UK</option>
      <option value="ru">RU</option><option value="ar">AR</option><option value="fa">FA</option>
    </select>
  </div>

  <div class="tabs">
    <div class="tab active" id="tab-list" onclick="showList()">Liste</div>
    <div class="tab" id="tab-map" onclick="showMap()">Karte</div>
  </div>

  <div class="chips" id="chips"></div>

  <div class="list" id="list"></div>
  
  <div class="mapwrap" id="mapwrap">
<div class="map" id="map">
  <img src="bilder/TXL Lageplan LAF-vektorisiert.png" alt="Karte" class="map-img" draggable="false" />

  <div class="pin" id="pin-P5" style="top:57.49%; left:33.25%;" data-x="33.25" data-y="57.49" data-wp="3.05">
    <img src="icons/P5Icon.png" alt="P5"/>
  </div>

  <div class="pin" id="pin-Kruemelecke" style="top:37.9%; left:28.25%;" data-x="28.25" data-y="37.9" data-wp="3.05">
    <img src="icons/KruemeleckeIcon.png" alt="KrÃ¼melecke"/>
  </div>

  <div class="pin" id="pin-Sandburg" style="left:24.7%; top:5.9%;" data-x="24.7" data-y="5.9" data-wp="3.05">
    <img src="icons/SandburgIcon.png" alt="Sandburg"/>
  </div>

  <div class="pin" id="pin-Q1" style="top:88.4%; left:44.4%;" data-x="44.4" data-y="88.4" data-wp="3.05">
    <img src="icons/Q1Icon.png" alt="Q1"/>
  </div>

  <div class="pin" id="pin-Q" style="top:88.9%; left:50%;" data-x="50" data-y="88.9" data-wp="3.05">
    <img src="icons/QIcon.png" alt="Q"/>
  </div>

  <div class="pin" id="pin-Post" style="top:39%; left:45.2%;" data-x="45.2" data-y="39" data-wp="3.05">
    <img src="icons/PostIcon.png" alt="Post"/>
  </div>

  <div class="pin" id="pin-Kleiderkammer" style="top:14.2%; left:54.4%;" data-x="54.4" data-y="14.2" data-wp="3.05">
    <img src="icons/KleiderkammerIcon.png" alt="Kleiderkammer"/>
  </div>

  <div class="pin" id="pin-Infopoint" style="top:40.96%; left:37.8%;" data-x="37.8" data-y="40.96" data-wp="3.05">
    <img src="icons/InfopointIcon.png" alt="Infopoint"/>
  </div>

  <div class="pin" id="pin-L1" style="top:20.3%; left:14.7%;" data-x="14.7" data-y="20.3" data-wp="3.05">
    <img src="icons/L1Icon.png" alt="L1"/>
  </div>

  <div class="pin" id="pin-L2" style="top:10.5%; left:14.7%;" data-x="14.7" data-y="10.5" data-wp="3.05">
    <img src="icons/L2Icon.png" alt="L2"/>
  </div>

  <div class="pin" id="pin-H" style="top:18.7%; left:28.25%;" data-x="28.25" data-y="18.7" data-wp="3.05">
    <img src="icons/HIcon.png" alt="H"/>
  </div>

  <div class="pin" id="pin-D3" style="top:9.7%; left:54.4%;" data-x="54.4" data-y="9.7" data-wp="3.05">
    <img src="icons/D3Icon.png" alt="D3"/>
  </div>

  <div class="pin" id="pin-M5" style="top:54.5%; left:61.5%;" data-x="61.5" data-y="54.5" data-wp="3.05">
    <img src="icons/M5Icon.png" alt="M5"/>
  </div>

  <div class="pin" id="pin-VWG1" style="top:54.8%; left:41.7%;" data-x="41.7" data-y="54.8" data-wp="3.05">
    <img src="icons/VWG1Icon.png" alt="VWG1"/>
  </div>

  <div class="pin" id="pin-VWG2" style="top:52.48%; left:38.02%;" data-x="38.02" data-y="52.48" data-wp="3.05">
    <img src="icons/VWG2Icon.png" alt="VWG2"/>
  </div>

  <div class="pin" id="pin-MedPoint" style="top:57.8%; left:39.7%;" data-x="39.7" data-y="57.8" data-wp="3.05">
    <img src="icons/MedPointIcon.png" alt="Med"/>
  </div>

  <div class="pin" id="pin-VWG3" style="top:57.45%; left:45.18%;" data-x="45.18" data-y="57.45" data-wp="3.05">
    <img src="icons/VWG3Icon.png" alt="VWG3"/>
  </div>

  <div class="pin" id="pin-KrÃ¤henwald" style="top:65.5%; left:34.5%;" data-x="34.5" data-y="65.5" data-wp="3.05">
    <img src="icons/KrÃ¤henwaldIcon.png" alt="KrÃ¤henwald"/>
  </div>

  <div class="pin" id="pin-WS" style="top:89%; left:74.5%;" data-x="74.5" data-y="89" data-wp="3.05">
    <img src="icons/WSIcon.png" alt="Willkommensschule"/>
  </div>

  <div class="pin" id="pin-Waschsalon" style="top:68%; left:40.5%;" data-x="40.5" data-y="68" data-wp="3.05">
    <img src="icons/WaschsalonIcon.png" alt="Waschsalon"/>
  </div>

  <div class="pin" id="pin-Bus" style="top:27.35%; left:42.5%;" data-x="42.5" data-y="27.35" data-wp="3.05">
    <img src="icons/BusIcon.png" alt="Bus"/>
  </div>

  <div class="pin" id="pin-Begleitdienst" style="top:44%; left:33.1%;" data-x="33.1" data-y="44" data-wp="3.05">
    <img src="icons/BegleitdienstIcon.png" alt="Begleitdienst"/>
  </div>

  <div class="pin" id="pin-Sozialerdienst" style="top:33.5%; left:27.3%;" data-x="27.3" data-y="33.5" data-wp="3.05">
    <img src="icons/SozialerdienstIcon.png" alt="Sozialer Dienst"/>
  </div>

  <div class="pin" id="pin-Checkin" style="top:39%; left:33.1%;" data-x="33.1" data-y="39" data-wp="3.05">
    <img src="icons/CheckinIcon.png" alt="Checkin"/>
  </div>

  <div class="pin" id="pin-Sprachmittlung" style="top:44%; left:35.5%;" data-x="35.5" data-y="44" data-wp="3.05">
    <img src="icons/SprachmittlungIcon.png" alt="Sprachmittlung"/>
  </div>

  <div class="pin" id="pin-Bistro" style="top:44%; left:44.5%;" data-x="44.5" data-y="44" data-wp="3.05">
    <img src="icons/BistroIcon.png" alt="Bistro"/>
  </div>
</div>



  <button class="exit-fullscreen" id="exitFsBtn" type="button">Zur Liste</button>

  <div class="sheet" id="sheet">
    <button class="close" onclick="closeSheet()">Ã—</button>
    <h3 id="sTitle"></h3>
    <div class="meta" id="sTime"></div>
    <div id="sText"></div>
    <div class="actions" id="sLinks"></div>
  </div>

<script src="translations.js"></script>
<script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
<script>
  console.log('[MAP] boot');Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // <â€” kleiner Rauchtest

/* ====== STATE & SETTINGS ====== */
let currentLang = 'de';
let panzoomInstance = null;
let currentMinScale = 1;

function setOptsSafe(opts = {}) {
Â  if (panzoomInstance && typeof panzoomInstance.setOptions === 'function') {
Â Â Â  panzoomInstance.setOptions(opts);
Â  }
}

function getTfSafe() {
Â  if (!panzoomInstance) return null;
Â  // v4-Varianten haben meist getScale/getPan, manche haben getTransform
Â  if (typeof panzoomInstance.getTransform === 'function') {
Â Â Â  return panzoomInstance.getTransform();
Â  }
Â  const s = (typeof panzoomInstance.getScale === 'function') ? panzoomInstance.getScale() : undefined;
Â  const p = (typeof panzoomInstance.getPanÂ Â  === 'function') ? panzoomInstance.getPan()Â Â  : undefined;
Â  return (s !== undefined && p) ? { x: p.x, y: p.y, scale: s } : null;
}

const MAP_W = 1920, MAP_H = 1080;
const isMobile = () => window.matchMedia('(max-width: 768px)').matches;

// 0 = linker Rand, 0.5 = Kartenmitte, 1 = rechter Rand
const START_X_PERCENT = 0.5;

/* ====== DOM ====== */
const wrapEl = document.getElementById('mapwrap');
const mapElÂ  = document.getElementById('map');

function tLabel(cat){ return cat.label?.[currentLang] || cat.label?.de || ''; }
function setLang(l){ currentLang=l; render(); }

/* ====== Viewport-Helfer ====== */
function setFullscreenVH() {
Â  const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
Â  document.documentElement.style.setProperty('--vh', `${h * 0.01}px`);
}
function enableVHWatchers() {
Â  setFullscreenVH();
Â  if (window.visualViewport) {
Â Â Â  visualViewport.addEventListener('resize', onVVChange);
Â Â Â  visualViewport.addEventListener('scroll', onVVChange);
Â  }
Â  window.addEventListener('orientationchange', onVVChange);
}
function disableVHWatchers() {
Â  if (window.visualViewport) {
Â Â Â  visualViewport.removeEventListener('resize', onVVChange);
Â Â Â  visualViewport.removeEventListener('scroll', onVVChange);
Â  }
Â  window.removeEventListener('orientationchange', onVVChange);
}

function onVVChange() {
Â  const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
Â  wrapEl.style.height = h + 'px';
Â  setFullscreenVH();

Â  if (!panzoomInstance) return;

Â  // Bei starken Ã„nderungen am unteren Ende wieder auf Fit oder letzten Fokus justieren
Â  requestAnimationFrame(() => {
Â Â Â  const min = currentMinScale;
Â Â Â  const t = getTfSafe();
Â Â Â  if (!t) return;

Â Â Â  // Wenn wir sehr nahe an minScale sind, frisch fitten
Â Â Â  if (Math.abs(t.scale - min) < 0.03) {
Â Â Â Â Â  const fit = computeFit(START_X_PERCENT);
Â Â Â Â Â  setOptsSafe({ minScale: fit.scale });
Â Â Â Â Â  currentMinScale = fit.scale;

Â Â Â Â Â  const targetScale = Math.max(fit.scale, TARGET_SCALE);
Â Â Â Â Â  const id = lastFocusId || getFocusFromURL();
Â Â Â Â Â  const tf = id ? computeTransformForPin(id, targetScale) : { ...fit, scale: targetScale };
Â Â Â Â Â  applyTransform(tf, false);
Â Â Â  }
Â  });
}

/* ====== Fit-Funktionen ====== */
function computeFit(xPercent = START_X_PERCENT, yAlign = 'center') {
Â  const rect = wrapEl.getBoundingClientRect();
Â  const scale = Math.min(rect.width / MAP_W, rect.height / MAP_H);
Â  const x = rect.width / 2 - (MAP_W * xPercent) * scale;Â Â Â Â Â Â Â Â Â Â  // gewÃ¼nschter Kartenanteil mittig
Â  const y = (yAlign === 'top') ? 0 : (rect.height - MAP_H * scale) / 2;
Â  return { scale, x, y };
}

function computeTransformForPin(id, scale) {
Â  const c = getPinCenter(id);
Â  if (!c) return null;

Â  const rect = wrapEl.getBoundingClientRect();
Â  const viewCx = rect.width / 2;
Â  const viewCy = rect.height / 2;

Â  // 1. Berechne die gewÃ¼nschte Pan-Position.
Â  // Pan-Wert ist der Unterschied zwischen Viewport-Mitte und dem skalierten Pin-Mittelpunkt.
Â  const x = viewCx - (c.cx * scale);
Â  const y = viewCy - (c.cy * scale);

Â  const mapW = MAP_W * scale;
Â  const mapH = MAP_H * scale;

Â  // 2. Bounding (Begrenzung): Stelle sicher, dass die Karte nicht aus dem Sichtfeld rutscht.
Â  let minX, maxX, minY, maxY;

Â  // Begrenzung fÃ¼r X
Â  if (mapW >= rect.width) {
Â Â Â  // Karte ist breiter als der Viewport
Â Â Â  minX = rect.width - mapW;
Â Â Â  maxX = 0;
Â  } else {
Â Â Â  // Karte ist schmaler, zentriere sie
Â Â Â  minX = maxX = (rect.width - mapW) / 2;
Â  }

Â  // Begrenzung fÃ¼r Y
Â  if (mapH >= rect.height) {
Â Â Â  // Karte ist hÃ¶her als der Viewport
Â Â Â  minY = rect.height - mapH;
Â Â Â  maxY = 0;
Â  } else {
Â Â Â  // Karte ist kÃ¼rzer, zentriere sie
Â Â Â  minY = maxY = (rect.height - mapH) / 2;
Â  }

Â  // 3. Klammere die berechneten Pan-Werte, damit sie innerhalb der Grenzen bleiben.
Â  // Eine kleine Pufferzone (BLEED) kann die Animation weicher machen.
Â  const BLEED = 10;
Â  const finalX = clamp(x, minX - BLEED, maxX + BLEED);
Â  const finalY = clamp(y, minY - BLEED, maxY + BLEED);

Â  return { x: finalX, y: finalY, scale };
}

// Hilfsfunktion zum Begrenzen eines Werts
function clamp(value, min, max) {
Â  return Math.max(min, Math.min(value, max));
}

/* ====== NAVIGATION ====== */
function enterMapFullscreen(){ document.body.classList.add('fullscreen-map'); }
function exitMapFullscreen(){ document.body.classList.remove('fullscreen-map'); }
document.getElementById('exitFsBtn')?.addEventListener('click', () => showList());

function showList(){
Â  document.getElementById('tab-list').classList.add('active');
Â  document.getElementById('tab-map').classList.remove('active');
Â  wrapEl.classList.remove('active');
Â  document.getElementById('list').style.display='grid';
Â  if (isMobile()) { exitMapFullscreen(); disableVHWatchers(); }
}

function waitForImage(imgEl, cb) {
Â  if (!imgEl) return;
Â  if (imgEl.complete) cb();
Â  else imgEl.addEventListener('load', cb, { once: true });
}

function getFocusFromURL() {
Â  try {
Â Â Â  const p = new URLSearchParams(location.search);
Â Â Â  const hash = location.hash || '';
Â Â Â  return p.get('focus') || (hash.startsWith('#pin-') ? decodeURIComponent(hash.slice(5)) : null);
Â  } catch { return null; }
}
const TARGET_SCALE = 1.8; // zentral definieren

function logRect(r){ return { w: Math.round(r.width), h: Math.round(r.height) }; }

function logTf(tag, tf){
Â  if(!tf) return console.log(tag, 'â€” no tf');
Â  console.log(tag, { x: Math.round(tf.x), y: Math.round(tf.y), s: +tf.scale.toFixed(3) });
}

function debugFocus(id, scale){
Â  const r = wrapEl.getBoundingClientRect();
Â  const c = getPinCenter(id);
Â  const tf = computeTransformForPin(id, scale);
Â  console.table({
Â Â Â  id,
Â Â Â  view: JSON.stringify(logRect(r)),
Â Â Â  cx: Math.round(c?.cx ?? -1),
Â Â Â  cy: Math.round(c?.cy ?? -1),
Â Â Â  scale: scale,
Â Â Â  tf_x: Math.round(tf?.x ?? 0),
Â Â Â  tf_y: Math.round(tf?.y ?? 0)
Â  });
}

function showMap(focusId = null) {
Â  // Tabs umschalten & UI aktualisieren
Â  document.getElementById('tab-map').classList.add('active');
Â  document.getElementById('tab-list').classList.remove('active');
Â  wrapEl.classList.add('active');
Â  document.getElementById('list').style.display = 'none';

Â  // Mobil: Vollbild & HÃ¶he setzen
Â  if (isMobile()) {
Â Â Â  enterMapFullscreen();
Â Â Â  setFullscreenVH();
Â Â Â  wrapEl.style.height = (window.visualViewport?.height || window.innerHeight) + 'px';
Â Â Â  enableVHWatchers();
Â  }

Â  const mapImgEl = document.querySelector('.map-img');

Â  waitForImage(mapImgEl, () => {
Â Â Â  // 1) Fit & minScale berechnen
Â Â Â  const fit = computeFit(START_X_PERCENT);
Â Â Â  const minScale = fit.scale;
Â Â Â  currentMinScale = minScale;

Â Â Â  // 2) Panzoom initialisieren (falls noch nicht geschehen)
Â Â Â  if (!panzoomInstance) {
Â Â Â Â Â  panzoomInstance = Panzoom(mapEl, {
Â Â Â Â Â Â Â  contain: 'outside',
Â Â Â Â Â Â Â  maxScale: 4,
Â Â Â Â Â Â Â  startScale: fit.scale,
Â Â Â Â Â Â Â  startX: fit.x,
Â Â Â Â Â Â Â  startY: fit.y,
Â Â Â Â Â Â Â  animate: true,
Â Â Â Â Â Â Â  duration: 350,
Â Â Â Â Â Â Â  easing: 'ease-in-out'
Â Â Â Â Â  });
Â Â Â Â Â  // Desktop: Mausrad-Zoom
Â Â Â Â Â  wrapEl.addEventListener('wheel', (e) => {
Â Â Â Â Â Â Â  e.preventDefault();
Â Â Â Â Â Â Â  panzoomInstance.zoomWithWheel(e, { animate: true });
Â Â Â Â Â  }, { passive: false });
Â  Â 
Â Â Â Â Â  window.panzoomInstance = panzoomInstance;
Â Â Â Â Â  window.wrapEl = wrapEl;
Â Â Â Â Â  window.mapEl = mapEl;
Â Â Â  } else {
Â Â Â Â Â Â Â  // Bei erneuter Ansicht: minScale aktualisieren
Â Â Â Â Â Â Â  panzoomInstance.setOptions({ minScale: minScale, animate: true });
Â Â Â  }

Â Â Â  // 3) Ziel-ID bestimmen & Pin highlighten
Â Â Â  const rawId = focusId || lastFocusId || getFocusFromURL() || null;
Â Â Â  const id = (typeof resolveId === 'function') ? resolveId(rawId) : rawId;

Â Â Â  if (id) {
Â Â Â Â Â  lastFocusId = id;
Â Â Â Â Â  highlightPin(id);
Â Â Â  } else {
Â Â Â Â Â  clearHighlight();
Â Â Â  }

Â Â Â  // 4) Transformation berechnen
Â Â Â  const targetScale = Math.max(minScale, TARGET_SCALE);
Â Â Â  const targetTf = id ? computeTransformForPin(id, targetScale) : { ...fit, scale: minScale };
Â  Â 
Â Â Â  // 5) Transformation anwenden
Â Â Â  if (targetTf) {
Â Â Â Â Â  // Korrekter Ansatz: Pan- und Zoom-Befehle nacheinander ausfÃ¼hren.
Â Â Â Â Â  panzoomInstance.pan(targetTf.x, targetTf.y, { animate: true, duration: 350 });
Â Â Â Â Â  setTimeout(() => {
Â Â Â Â Â Â Â  panzoomInstance.zoom(targetTf.scale, { animate: true, duration: 350 });
Â Â Â Â Â  }, 50);

Â Â Â Â Â  console.log(`ðŸ” Fokus auf ${id} â†’ x:${Math.round(targetTf.x)} y:${Math.round(targetTf.y)} s:${targetTf.scale.toFixed(2)}`);
Â Â Â  } else {
Â Â Â Â Â  console.warn(`[MAP] Konnte Pin ${id} nicht fokussieren.`);
Â Â Â  }
Â  }); // waitForImage
}

/* ====== LISTE & DATEN ====== */
const categories = [
Â  // Kids / Freizeit
Â  { id:'kids', label:{de:'Kinder & Freizeit', en:'Kids & Leisure'},
Â  areas: ['D3', 'Kruemelecke', 'L1', 'L2', 'M5', 'P5', 'Q1', 'Sandburg']},

Â  // Medizin / Hilfe
Â  { id:'health', label:{de:'Medizin & Hilfe', en:'Medical & Help'},
Â Â Â  areas:['MedPoint','Sozialerdienst','VWG1','VWG2','VWG3'] }, // 

Â  // Services / Info
Â  { id:'services', label:{de:'Service & Info', en:'Services & Info'},areas: ['Begleitdienst', 'Bistro', 'Checkin', 'Infopoint', 'Kleiderkammer', 'Post', 'Sprachmittlung', 'Waschsalon'] },

Â  // GelÃ¤nde / Orientierung
Â  { id:'site', label:{de:'GelÃ¤nde', en:'Site'},
Â Â Â  areas:['Q','KrÃ¤henwald','WS','Bus','H'] }
];

let lastFocusId = null;Â Â Â Â Â Â Â  // z.B. 'MedPoint'
let highlightedPinId = null;

function highlightPin(id) {
Â  // altes Highlight entfernen
Â  if (highlightedPinId) {
Â Â Â  const prev = document.getElementById(`pin-${highlightedPinId}`);
Â Â Â  if (prev) prev.classList.remove('highlight');
Â  }
Â  // neues setzen
Â  const el = document.getElementById(`pin-${id}`);
Â  if (el) {
Â Â Â  el.classList.add('highlight');
Â Â Â  highlightedPinId = id;
Â  }
}

function clearHighlight() {
Â  if (!highlightedPinId) return;
Â  const el = document.getElementById(`pin-${highlightedPinId}`);
Â  if (el) el.classList.remove('highlight');
Â  highlightedPinId = null;
}

// (optional) Alias-AuflÃ¶sung, falls mal "med" statt "MedPoint" Ã¼bergeben wird
const aliases = { med: 'MedPoint', medpoint: 'MedPoint', 'med point':'MedPoint' };
function resolveId(id) {
Â  if (!id) return id;
Â  const key = String(id).toLowerCase();
Â  return aliases[key] || id;
}


// ===== DEBUG-HARNESS: Panzoom Tests =====
window.__mapTest = {
Â  check() {
Â Â Â  const okLib = typeof Panzoom === 'function';
Â Â Â  const okWrap = !!wrapEl && wrapEl.getBoundingClientRect();
Â Â Â  const okMapÂ  = !!mapEl && mapEl.getBoundingClientRect();
Â Â Â  const imgÂ Â Â  = document.querySelector('.map-img');
Â Â Â  const csÂ Â Â Â  = mapEl ? getComputedStyle(mapEl).transform : 'n/a';
Â Â Â  console.log('[CHECK]', {
Â Â Â Â Â  panzoomLoaded: okLib,
Â Â Â Â Â  wrapSize: okWrap ? wrapEl.getBoundingClientRect() : null,
Â Â Â Â Â  mapSize:Â  okMapÂ  ? mapEl.getBoundingClientRect()Â  : null,
Â Â Â Â Â  imgComplete: !!img?.complete,
Â Â Â Â Â  cssTransformOnMap: cs
Â Â Â  });
Â  },

Â  init() {
Â Â Â  const fit = computeFit(START_X_PERCENT);
Â Â Â  if (!panzoomInstance) {
Â Â Â Â Â  panzoomInstance = Panzoom(mapEl, {
Â Â Â Â Â Â Â  maxScale: 4,
Â Â Â Â Â Â Â  contain: 'outside',
Â Â Â Â Â Â Â  startScale: fit.scale,
Â Â Â Â Â Â Â  startX: fit.x,
Â Â Â Â Â Â Â  startY: fit.y,
Â Â Â Â Â Â Â  animate: true,
Â Â Â Â Â Â Â  duration: 350,
Â Â Â Â Â Â Â  easing: 'ease-in-out'
Â Â Â Â Â  });
Â Â Â Â Â  console.log('[INIT] panzoom created â†’', panzoomInstance.getTransform());
Â Â Â Â Â  wrapEl.addEventListener('wheel', (e) => { e.preventDefault(); panzoomInstance.zoomWithWheel(e); }, { passive: false });
Â Â Â  } else {
Â Â Â Â Â  console.log('[INIT] reuse â†’', panzoomInstance.getTransform());
Â Â Â  }
Â Â Â  panzoomInstance.setOptions({ minScale: fit.scale });
Â Â Â  // auf Fit setzen
Â Â Â  panzoomInstance.setTransform(fit);
Â Â Â  return panzoomInstance.getTransform();
Â  },

Â  nudge() {
Â Â Â  const fit = computeFit(START_X_PERCENT);
Â Â Â  panzoomInstance.setOptions({ animate: false });
Â Â Â  panzoomInstance.setTransform({ x: fit.x + 1, y: fit.y + 1, scale: fit.scale });
Â Â Â  panzoomInstance.setTransform(fit);
Â Â Â  console.log('[NUDGE] applied');
Â Â Â  return panzoomInstance.getTransform();
Â  },

Â  fit() {
Â Â Â  const fit = computeFit(START_X_PERCENT);
Â Â Â  panzoomInstance.setTransform(fit);
Â Â Â  console.log('[FIT] â†’', fit);
Â Â Â  return fit;
Â  },

Â  zoomCenter(scale = 2.5) {
Â Â Â  const rect = wrapEl.getBoundingClientRect();
Â Â Â  const x = rect.widthÂ  / 2 - (MAP_W * 0.5) * scale;
Â Â Â  const y = rect.height / 2 - (MAP_H * 0.5) * scale;
Â Â Â  panzoomInstance.setTransform({ x, y, scale });
Â Â Â  console.log('[ZOOM CENTER]', { x, y, scale });
Â Â Â  return panzoomInstance.getTransform();
Â  },

Â  focus(id, scale = 2.5) {
Â Â Â  const tf = computeTransformForPin(id, Math.max(scale, (computeFit(START_X_PERCENT).scale)));
Â Â Â  console.log('[FOCUS]', id, tf);
Â Â Â  if (tf) {
Â Â Â Â Â  panzoomInstance.setTransform(tf);
Â Â Â Â Â  highlightPin && highlightPin(id);
Â Â Â  } else {
Â Â Â Â Â  console.warn('[FOCUS] kein Transform fÃ¼r', id);
Â Â Â  }
Â Â Â  return panzoomInstance?.getTransform();
Â  },

Â  animTo(target, duration = 400) {
Â Â Â  const start = panzoomInstance.getTransform();
Â Â Â  const t0 = performance.now();
Â Â Â  function tick(now) {
Â Â Â Â Â  const t = Math.min(1, (now - t0) / duration);
Â Â Â Â Â  const k = 0.5 - 0.5 * Math.cos(Math.PI * t);
Â Â Â Â Â  panzoomInstance.setTransform({
Â Â Â Â Â Â Â  x: start.x + (target.x - start.x) * k,
Â Â Â Â Â Â Â  y: start.y + (target.y - start.y) * k,
Â Â Â Â Â Â Â  scale: start.scale + (target.scale - start.scale) * k,
Â Â Â Â Â  });
Â Â Â Â Â  if (t < 1) requestAnimationFrame(tick);
Â Â Â  }
Â Â Â  requestAnimationFrame(tick);
Â  },

Â  animFocus(id, scale = 2.5, duration = 400) {
Â Â Â  const tf = computeTransformForPin(id, Math.max(scale, (computeFit(START_X_PERCENT).scale)));
Â Â Â  console.log('[ANIM FOCUS]', id, tf);
Â Â Â  if (tf) this.animTo(tf, duration);
Â  }
};

function render(){
Â  const chips = document.getElementById('chips'); chips.innerHTML='';
Â  categories.forEach(c=>{
Â Â Â  const el=document.createElement('button');
Â Â Â  el.className='chip'; el.textContent=tLabel(c);
Â Â Â  el.onclick=()=>renderList(c.areas);
Â Â Â  chips.appendChild(el);
Â  });
Â  renderList(categories.flatMap(c=>c.areas));
}
function renderList(areaIds){
Â  const list = document.getElementById('list'); 
Â  list.innerHTML = '';

Â  areaIds.forEach(id => {
Â Â Â  const data = translations[id]?.[currentLang]; 
Â Â Â  if (!data) return;

Â Â Â  const card = document.createElement('div'); 
Â Â Â  card.className = 'card';
Â Â Â  if (id === lastFocusId) card.classList.add('selected'); // << neu

Â Â Â  const icon = document.createElement('img'); 
Â Â Â  icon.src = `icons/${id}Icon.png`; 
Â Â Â  icon.alt = id; 
Â Â Â  icon.style.width = '52px'; 
Â Â Â  icon.style.height = '52px';

Â Â Â  const body = document.createElement('div');
Â Â Â  const h = document.createElement('h3'); h.textContent = data.title || id;
Â Â Â  const meta = document.createElement('div'); meta.className = 'meta'; meta.innerHTML = data.time || '';
Â Â Â  const txt = document.createElement('div'); txt.className = 'meta'; txt.innerHTML = data.text || '';

Â Â Â  const actions = document.createElement('div'); actions.className = 'actions';
Â Â Â  const btn1 = document.createElement('button'); btn1.className = 'btn'; btn1.textContent = 'Details';
Â Â Â  btn1.onclick = (e) => { e.stopPropagation(); lastFocusId = id; openSheet(id); }; // << gemerkt

Â Â Â  const btn2 = document.createElement('button'); btn2.className = 'btn ghost'; btn2.textContent = 'Auf Karte zeigen';
Â Â Â  btn2.onclick = (e) => { e.stopPropagation(); lastFocusId = id; showMap(id); }; // << neu: direkt mit ID

Â Â Â  actions.append(btn1, btn2);
Â Â Â  body.append(h, meta, txt, actions);
Â Â Â  card.append(icon, body);
Â Â Â  list.appendChild(card);

Â Â Â  // Klick auf die Karte selbst markiert die Auswahl (fÃ¼r spÃ¤teren Tab-Wechsel auf "Karte")
Â Â Â  card.addEventListener('click', () => {
Â Â Â Â Â  lastFocusId = id;
Â Â Â Â Â  // optisch updaten
Â Â Â Â Â  document.querySelectorAll('.card.selected').forEach(el => el.classList.remove('selected'));
Â Â Â Â Â  card.classList.add('selected');
Â Â Â  });
}
}

document.querySelectorAll('.pin').forEach(el => {
Â  el.addEventListener('click', () => {
Â Â Â  const id = el.id.replace('pin-','');
Â Â Â  lastFocusId = id;
Â Â Â  highlightPin(id);
Â Â Â  openSheet(id);
Â  });
});


function openSheet(id){
Â  const d=translations[id]?.[currentLang]; if(!d) return;
Â  document.getElementById('sTitle').textContent=d.title||id;
Â  document.getElementById('sTime').innerHTML=d.time||'';
Â  document.getElementById('sText').innerHTML=d.text||'';
Â  const links=document.getElementById('sLinks'); links.innerHTML='';
Â  (d.links||[]).forEach(l=>{
Â Â Â  const a=document.createElement('a'); a.href=l.url; a.target='_blank';
Â Â Â  a.className='btn'; a.textContent=l.text||'Mehr';
Â Â Â  links.appendChild(a);
Â  });
Â  document.getElementById('sheet').classList.add('open');
}
function closeSheet(){ document.getElementById('sheet').classList.remove('open'); }


function getPinCenter(id) {
Â  const el = document.getElementById(`pin-${id}`);
Â  if (!el) return null;

Â  // robustes Parsen (unterstÃ¼tzt "54,4" u. "54.4")
Â  const toNum = v => v == null ? NaN : parseFloat(String(v).replace(',', '.'));

Â  const dx = toNum(el.dataset.x);Â  // left in %
Â  const dy = toNum(el.dataset.y);Â  // top in %
Â  const wp = toNum(el.dataset.wp); // box-breite in % (von MAP_W)

Â  if (!Number.isNaN(dx) && !Number.isNaN(dy)) {
Â Â Â  // halbe Box-Breite in %-von-MAP_W
Â Â Â  const halfW_pct_of_W = Number.isNaN(wp) ? 0 : wp / 2;

Â Â Â  // halbe Box-HÃ¶he in %-von-MAP_H (Icon ist quadratisch â‡’ HÃ¶hePx = BreitePx)
Â Â Â  // HÃ¶he% relativ zur KartenHÃ¶he = (BreitePx / MAP_H)*100 = wp * (MAP_W / MAP_H)
Â Â Â  const halfH_pct_of_H = Number.isNaN(wp) ? 0 : (wp * (MAP_W / MAP_H)) / 2;

Â Â Â  const cx = ((dx + halfW_pct_of_W) / 100) * MAP_W;
Â Â Â  const cy = ((dy + halfH_pct_of_H) / 100) * MAP_H;
Â Â Â  return { cx, cy };
Â  }

Â  return null;
}
Â  
// ===== DEBUG-KIT: alles zur Konsole =====
(function () {
Â  // Hilfsfunktionen (Ã¤ndern nichts am Verhalten)
Â  function getRect() {
Â Â Â  const r = wrapEl.getBoundingClientRect();
Â Â Â  return { w: Math.round(r.width), h: Math.round(r.height) };
Â  }
Â  function getMapSize(scale) {
Â Â Â  return { w: Math.round(MAP_W * scale), h: Math.round(MAP_H * scale) };
Â  }
Â  function getDomCenter(id) {
Â Â Â  const el = document.getElementById(`pin-${id}`);
Â Â Â  if (!el) return null;
Â Â Â  return {
Â Â Â Â Â  cx: el.offsetLeft + el.offsetWidth / 2,
Â Â Â Â Â  cy: el.offsetTopÂ  + el.offsetHeight / 2,
Â Â Â Â Â  note: "DOM-offset (ignoriert data-%)"
Â Â Â  };
Â  }
Â  function getPctCenter(id) {
Â Â Â  // das ist exakt deine getPinCenter-Logik â€“ einmal separat, nur zum Vergleichen
Â Â Â  const el = document.getElementById(`pin-${id}`);
Â Â Â  if (!el) return null;
Â Â Â  const toNum = v => v == null ? NaN : parseFloat(String(v).replace(',', '.'));
Â Â Â  const dx = toNum(el.dataset.x);
Â Â Â  const dy = toNum(el.dataset.y);
Â Â Â  const wp = toNum(el.dataset.wp);
Â Â Â  if (!Number.isNaN(dx) && !Number.isNaN(dy)) {
Â Â Â Â Â  const halfW_pct_of_W = Number.isNaN(wp) ? 0 : wp / 2;
Â Â Â Â Â  const halfH_pct_of_H = Number.isNaN(wp) ? 0 : (wp * (MAP_W / MAP_H)) / 2;
Â Â Â Â Â  const cx = ((dx + halfW_pct_of_W) / 100) * MAP_W;
Â Â Â Â Â  const cy = ((dy + halfH_pct_of_H) / 100) * MAP_H;
Â Â Â Â Â  return { cx, cy, note: "data-% gerechnet" };
Â Â Â  }
Â Â Â  return null;
Â  }
Â  function clamp(v, min, max) { return Math.min(max, Math.max(min, v)); }

Â  // 1) Gesamtsnapshot des aktuellen Zustands
Â  function snapshot(tag = 'SNAP') {
Â Â Â  const tf = getTfSafe();
Â Â Â  const rÂ  = wrapEl.getBoundingClientRect();
Â Â Â  const min = currentMinScale;
Â Â Â  console.group(`[${tag}]`);
Â Â Â  console.table({
Â Â Â Â Â  viewport: `${Math.round(r.width)}Ã—${Math.round(r.height)}`,
Â Â Â Â Â  transform_x: Math.round(tf?.x ?? 0),
Â Â Â Â Â  transform_y: Math.round(tf?.y ?? 0),
Â Â Â Â Â  scale: +(tf?.scale ?? 0).toFixed(3),
Â Â Â Â Â  minScale: +min.toFixed(3),
Â Â Â Â Â  map_px: `${Math.round(MAP_W*(tf?.scale||1))}Ã—${Math.round(MAP_H*(tf?.scale||1))}`,
Â Â Â Â Â  contain: (panzoomInstance?.getOptions?.().contain) || '(n/a)'
Â Â Â  });
Â Â Â  console.groupEnd();
Â  }

Â  // 2) Details zu einem Pin + Ziel-Transform
Â  function showDebugInfo(id, scale) {
Â Â Â  const r = getRect();
Â Â Â  const c = getPctCenter(id);
Â Â Â  const tf = computeTransformForPin(id, scale);
Â Â Â  console.group(`[DEBUG] Fokus auf ${id}`);
Â Â Â  console.table({
Â Â Â Â Â  'Viewport GrÃ¶ÃŸe': `${r.w}x${r.h}`,
Â Â Â Â Â  'Pin-Mitte (Daten)': c,
Â Â Â Â Â  'Ziel-MaÃŸstab': scale,
Â Â Â Â Â  'Berechneter Pan-X': tf?.x,
Â Â Â Â Â  'Berechneter Pan-Y': tf?.y
Â Â Â  });
Â Â Â  console.groupEnd();
Â Â Â  return tf;
Â  }

Â  // API zur Konsole hinzufÃ¼gen
Â  window.debug = {
Â Â Â  snapshot,
Â Â Â  debugPin: showDebugInfo,
Â Â Â  focus: (id) => showMap(id),
Â Â Â  animTest: (id, scale) => {
Â Â Â Â Â  const tf = showDebugInfo(id, scale);
Â Â Â Â Â  if (!tf) return;
Â Â Â Â Â  panzoomInstance.pan(tf.x, tf.y, { animate: true, duration: 350 });
Â Â Â Â Â  setTimeout(() => {
Â Â Â Â Â Â Â  panzoomInstance.zoom(tf.scale, { animate: true, duration: 350 });
Â Â Â Â Â  }, 50);
Â Â Â  }
Â  };
})();
render();





