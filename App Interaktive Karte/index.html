<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TXL Guide</title>
<style>
  :root { --pad: 16px; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, sans-serif; background:#f7f7f8; }

  /* Header */
  .topbar { position:sticky; top:0; z-index:5; display:flex; gap:12px;
    align-items:center; padding:12px var(--pad); background:#fff; border-bottom:1px solid #e6e6e8; }
  .title { font-weight:700; font-size:18px; }
  .lang { margin-left:auto; }

  /* Tabs */
  .tabs { position:sticky; top:56px; z-index:4; display:flex; gap:8px; padding:8px var(--pad);
    background:#fff; border-bottom:1px solid #eee; }
  .tab { flex:1; text-align:center; padding:10px; border-radius:10px; background:#f0f0f2; cursor:pointer; }
  .tab.active { background:#111; color:#fff; }

  /* Kategorie-Chips */
  .chips { display:flex; gap:8px; overflow:auto; padding:10px var(--pad); }
  .chip { white-space:nowrap; padding:8px 12px; border-radius:999px; background:#fff; border:1px solid #e5e5e7; cursor:pointer; }

  /* Liste */
  .list { padding:12px var(--pad) 80px; display:grid; gap:12px; }
  .card { background:#fff; border:1px solid #eee; border-radius:14px; padding:14px; display:grid; grid-template-columns:52px 1fr; gap:12px; }
  .card h3 { margin:0 0 6px; font-size:16px; }
  .meta { color:#555; font-size:13px; }
  .actions { margin-top:8px; display:flex; gap:8px; }
  .btn { padding:10px 12px; border-radius:10px; background:#111; color:#fff; font-size:14px; border:none; cursor:pointer; }
  .btn.ghost { background:#fff; color:#111; border:1px solid #ddd; }

  /* Karte */
  .mapwrap {
    display:none;
    height:calc(100vh - 112px);
    overflow:hidden;
    position:relative;
    background:#000;
    touch-action:none;
    overscroll-behavior: contain;
  }
  .mapwrap.active { display:block; }

  .map {
    position:relative;
    width:1920px;
    height:1080px;
    touch-action:none;
    will-change: transform;
  }

  .map-img {
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:fill;
    display:block;
    user-select:none;
    pointer-events:none;
  }

.pin {
  position: absolute;
  /* Entferne die Zentrierung */
  transform: none;         /* <- wichtig */
  /* mach die Größe wieder relativ, wenn du das alte Verhalten liebst */
  width: 3.05%;
  height: auto;
  cursor: pointer;
}
.pin img {
  width: 70%;
  height: auto;
  pointer-events: none;
}

  /* Pin-Highlight */
.pin { transform-origin: center center; } /* wichtig, damit Scale nicht verrutscht */
.pin.highlight { z-index: 6; transform: scale(1.25); }
.pin.highlight img {
  filter: drop-shadow(0 0 10px rgba(255, 210, 0, 0.95));
  animation: pinPulse 1.2s ease-in-out infinite;
}
@keyframes pinPulse {
  0%, 100% { transform: scale(1); }
  50%      { transform: scale(1.08); }
}

/* (optional) ausgewählte Karte in der Liste visuell markieren */
.card.selected {
  border-color: #111;
  box-shadow: 0 0 0 2px #111 inset;
}

  /* Bottom Sheet */
  .sheet { position:fixed; left:0; right:0; bottom:-100%; background:#fff; border-radius:16px 16px 0 0;
    box-shadow:0 -10px 30px rgba(0,0,0,.2); padding:16px; transition:bottom .25s ease; z-index:10; max-height:70vh; overflow:auto; }
  .sheet.open { bottom:0; }
  .sheet h3 { margin:0 0 8px; }
  .sheet .meta { margin-bottom:10px; }
  .sheet .close { position:absolute; right:12px; top:12px; font-size:20px; border:none; background:transparent; cursor:pointer; }

  /* Mobile: Vollbild-Karte */
  @media (max-width: 768px) {
    body.fullscreen-map .topbar,
    body.fullscreen-map .tabs,
    body.fullscreen-map .chips { display:none; }

    body.fullscreen-map { overflow:hidden; }

    body.fullscreen-map .mapwrap {
      position: fixed;
      inset: 0;
      z-index: 9999;
      width: 100vw;
      height: calc(var(--vh, 1vh) * 100); /* kommt aus JS */
      display: block !important;
      background: #000;
      touch-action: none;
      overscroll-behavior: contain;
    }

    .exit-fullscreen {
      position: fixed;
      z-index: 10000;
      right: 12px; top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #333;
      background: rgba(255,255,255,.9);
      font-weight: 600;
    }
    body:not(.fullscreen-map) .exit-fullscreen { display:none; }
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="title">TXL Guide</div>
    <select class="lang" id="lang" onchange="setLang(this.value)">
      <option value="de">DE</option><option value="en">EN</option>
      <option value="tr">TR</option><option value="uk">UK</option>
      <option value="ru">RU</option><option value="ar">AR</option><option value="fa">FA</option>
    </select>
  </div>

  <div class="tabs">
    <div class="tab active" id="tab-list" onclick="showList()">Liste</div>
    <div class="tab" id="tab-map" onclick="showMap()">Karte</div>
  </div>

  <div class="chips" id="chips"></div>

  <div class="list" id="list"></div>
  
  <div class="mapwrap" id="mapwrap">
    <div class="map" id="map">
      <img src="bilder/TXL Lageplan LAF-vektorisiert.png" alt="Karte" class="map-img" draggable="false" />
<div class="pin" id="pin-P5" style="top:57.49%; left:33.25%;"><img src="icons/P5Icon.png" alt="P5"/></div>
<div class="pin" id="pin-Kruemelecke" style="top:37.9%; left:28.25%;"><img src="icons/KruemeleckeIcon.png" alt="Krümelecke"/></div>
<div class="pin" id="pin-Sandburg" style="left:24.7%; top:5.9%;"><img src="icons/SandburgIcon.png" alt="Sandburg"/></div>
<div class="pin" id="pin-Q1" style="top:88.4%; left:44.4%;"><img src="icons/Q1Icon.png" alt="Q1"/></div>
<div class="pin" id="pin-Q" style="top:88.9%; left:50%;"><img src="icons/QIcon.png" alt="Q"/></div>
<div class="pin" id="pin-Post" style="top:39%; left:45.2%;"><img src="icons/PostIcon.png" alt="Post"/></div>
<div class="pin" id="pin-Kleiderkammer" style="top:14.2%; left:54.4%;"><img src="icons/KleiderkammerIcon.png" alt="Kleiderkammer"/></div>
<div class="pin" id="pin-Infopoint" style="top:40.96%; left:37.8%;"><img src="icons/InfopointIcon.png" alt="Infopoint"/></div>
<div class="pin" id="pin-L1" style="top:20.3%; left:14.7%;"><img src="icons/L1Icon.png" alt="L1"/></div>
<div class="pin" id="pin-L2" style="top:10.5%; left:14.7%;"><img src="icons/L2Icon.png" alt="L2"/></div>
<div class="pin" id="pin-H" style="top:18.7%; left:28.25%;"><img src="icons/HIcon.png" alt="H"/></div>
<div class="pin" id="pin-D3" style="top:9.7%; left:54.4%;"><img src="icons/D3Icon.png" alt="D3"/></div>
<div class="pin" id="pin-M5" style="top:54.5%; left:61.5%;"><img src="icons/M5Icon.png" alt="M5"/></div>
<div class="pin" id="pin-VWG1" style="top:54.8%; left:41.7%;"><img src="icons/VWG1Icon.png" alt="VWG1"/></div>
<div class="pin" id="pin-VWG2" style="top:52.48%; left:38.02%;"><img src="icons/VWG2Icon.png" alt="VWG2"/></div>
<div class="pin" id="pin-MedPoint" style="top:57.8%; left:39.7%;"><img src="icons/MedPointIcon.png" alt="Med"/></div>
<div class="pin" id="pin-VWG3" style="top:57.45%; left:45.18%;"><img src="icons/VWG3Icon.png" alt="VWG3"/></div>
<div class="pin" id="pin-Krähenwald" style="top:65.5%; left:34.5%;"><img src="icons/KrähenwaldIcon.png" alt="Krähenwald"/></div>
<div class="pin" id="pin-WS" style="top:89%; left:74.5%;"><img src="icons/WSIcon.png" alt="Willkommensschule"/></div>
<div class="pin" id="pin-Waschsalon" style="top:68%; left:40.5%;"><img src="icons/WaschsalonIcon.png" alt="Waschsalon"/></div>
<div class="pin" id="pin-Bus" style="top:27.35%; left:42.5%;"><img src="icons/BusIcon.png" alt="Bus"/></div>
<div class="pin" id="pin-Begleitdienst" style="top:44%; left:33.1%;"><img src="icons/BegleitdienstIcon.png" alt="Begleitdienst"/></div>
<div class="pin" id="pin-Sozialerdienst" style="top:33.5%; left:27.3%;"><img src="icons/SozialerdienstIcon.png" alt="Sozialer Dienst"/></div>
<div class="pin" id="pin-Checkin" style="top:39%; left:33.1%;"><img src="icons/CheckinIcon.png" alt="Checkin"/></div>
<div class="pin" id="pin-Sprachmittlung" style="top:44%; left:35.5%;"><img src="icons/SprachmittlungIcon.png" alt="Sprachmittlung"/></div>
<div class="pin" id="pin-Bistro" style="top:44%; left:44.5%;"><img src="icons/BistroIcon.png" alt="Bistro"/></div>
    </div>
  </div>

  <button class="exit-fullscreen" id="exitFsBtn" type="button">Zur Liste</button>

  <div class="sheet" id="sheet">
    <button class="close" onclick="closeSheet()">×</button>
    <h3 id="sTitle"></h3>
    <div class="meta" id="sTime"></div>
    <div id="sText"></div>
    <div class="actions" id="sLinks"></div>
  </div>

<script src="translations.js"></script>
<script src="https://unpkg.com/@panzoom/panzoom/dist/panzoom.min.js"></script>
<script>
  /* ====== STATE & SETTINGS ====== */
  let currentLang = 'de';
  let panzoomInstance = null;

  const MAP_W = 1920, MAP_H = 1080;
  const isMobile = () => window.matchMedia('(max-width: 768px)').matches;

  // 0 = linker Rand, 0.5 = Kartenmitte, 1 = rechter Rand
  const START_X_PERCENT = 0.5;

  /* ====== DOM ====== */
  const wrapEl = document.getElementById('mapwrap');
  const mapEl  = document.getElementById('map');

  function tLabel(cat){ return cat.label?.[currentLang] || cat.label?.de || ''; }
  function setLang(l){ currentLang=l; render(); }

  /* ====== Viewport-Helfer ====== */
  function setFullscreenVH() {
    const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    document.documentElement.style.setProperty('--vh', `${h * 0.01}px`);
  }
  function enableVHWatchers() {
    setFullscreenVH();
    if (window.visualViewport) {
      visualViewport.addEventListener('resize', onVVChange);
      visualViewport.addEventListener('scroll', onVVChange);
    }
    window.addEventListener('orientationchange', onVVChange);
  }
  function disableVHWatchers() {
    if (window.visualViewport) {
      visualViewport.removeEventListener('resize', onVVChange);
      visualViewport.removeEventListener('scroll', onVVChange);
    }
    window.removeEventListener('orientationchange', onVVChange);
  }
  function onVVChange() {
    const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    wrapEl.style.height = h + 'px';
    setFullscreenVH();
    if (panzoomInstance) {
      requestAnimationFrame(() => {
        const t = panzoomInstance.getTransform();
        const min = panzoomInstance.getOptions().minScale ?? 0;
        if (Math.abs(t.scale - min) < 0.03) fitAndCenter(START_X_PERCENT);
      });
    }
  }

  /* ====== Fit-Funktionen ====== */
  function computeFit(xPercent = START_X_PERCENT, yAlign = 'center') {
    const rect = wrapEl.getBoundingClientRect();
    const scale = Math.min(rect.width / MAP_W, rect.height / MAP_H);
    const x = rect.width / 2 - (MAP_W * xPercent) * scale;           // gewünschter Kartenanteil mittig
    const y = (yAlign === 'top') ? 0 : (rect.height - MAP_H * scale) / 2;
    return { scale, x, y };
  }

  function fitAndCenter(xPercent = START_X_PERCENT) {
    if (!panzoomInstance) return;
    const { scale, x, y } = computeFit(xPercent);
    panzoomInstance.setTransform({ x, y, scale });
    panzoomInstance.setOptions({ minScale: scale });
  }

  /* ====== NAVIGATION ====== */
  function enterMapFullscreen(){ document.body.classList.add('fullscreen-map'); }
  function exitMapFullscreen(){ document.body.classList.remove('fullscreen-map'); }
  document.getElementById('exitFsBtn')?.addEventListener('click', () => showList());

  function showList(){
    document.getElementById('tab-list').classList.add('active');
    document.getElementById('tab-map').classList.remove('active');
    wrapEl.classList.remove('active');
    document.getElementById('list').style.display='grid';
    if (isMobile()) { exitMapFullscreen(); disableVHWatchers(); }
  }

  function waitForImage(imgEl, cb) {
    if (!imgEl) return;
    if (imgEl.complete) cb();
    else imgEl.addEventListener('load', cb, { once: true });
  }
  
function getFocusFromURL() {
  try {
    const p = new URLSearchParams(location.search);
    const hash = location.hash || '';
    return p.get('focus') || (hash.startsWith('#pin-') ? decodeURIComponent(hash.slice(5)) : null);
  } catch { return null; }
}
  
 function showMap(focusId = null){
  document.getElementById('tab-map').classList.add('active');
  document.getElementById('tab-list').classList.remove('active');
  wrapEl.classList.add('active');
  document.getElementById('list').style.display = 'none';

  if (isMobile()) {
    enterMapFullscreen();
    setFullscreenVH();
    wrapEl.style.height = (window.visualViewport?.height || window.innerHeight) + 'px';
    enableVHWatchers();
  }

  const mapImgEl = document.querySelector('.map-img');

  waitForImage(mapImgEl, () => {
    const doFit = () => {
      setFullscreenVH();
      wrapEl.style.height = (window.visualViewport?.height || window.innerHeight) + 'px';
      const { scale, x, y } = computeFit(START_X_PERCENT);

      if (!panzoomInstance) {
        panzoomInstance = Panzoom(mapEl, {
          maxScale: 4,
          contain: 'outside',
          startScale: scale,
          startX: x,
          startY: y,
          animate: true
        });
        wrapEl.addEventListener('wheel', (e) => {
          e.preventDefault();
          panzoomInstance.zoomWithWheel(e);
        }, { passive: false });
      }
      panzoomInstance.setOptions({ minScale: scale });
      panzoomInstance.setTransform({ x, y, scale });
    };

    // Fokussier-Ziel bestimmen: Übergabe-ID > gemerkte ID > URL > (kein Fokus)
    focusId = resolveId(
      focusId || lastFocusId || (typeof getFocusFromURL === 'function' ? getFocusFromURL() : null)
    );

    doFit(); // sofort
    setTimeout(() => {
      doFit(); // Sicherheits-Fit
      if (focusId) {
        // erst highlighten, dann zoomen/zentrieren
        highlightPin(focusId);
        setTimeout(() => focusPin(focusId, 2), 0); // 2 = Zielzoom
      }
    }, 150);
  });
}


  /* ====== LISTE & DATEN ====== */
const categories = [
  // Kids / Freizeit
  { id:'kids', label:{de:'Kinder & Freizeit', en:'Kids & Leisure'},
  areas: ['D3', 'Kruemelecke', 'L1', 'L2', 'M5', 'P5', 'Q1', 'Sandburg']},

  // Medizin / Hilfe
  { id:'health', label:{de:'Medizin & Hilfe', en:'Medical & Help'},
    areas:['MedPoint','Sozialerdienst','VWG1','VWG2','VWG3'] }, // 

  // Services / Info
  { id:'services', label:{de:'Service & Info', en:'Services & Info'},areas: ['Begleitdienst', 'Bistro', 'Checkin', 'Infopoint', 'Kleiderkammer', 'Post', 'Sprachmittlung', 'Waschsalon'] },

  // Gelände / Orientierung
  { id:'site', label:{de:'Gelände', en:'Site'},
    areas:['Q','Krähenwald','WS','Bus','H'] }
];

  let lastFocusId = null;        // z.B. 'MedPoint'
let highlightedPinId = null;

function highlightPin(id) {
  // altes Highlight entfernen
  if (highlightedPinId) {
    const prev = document.getElementById(`pin-${highlightedPinId}`);
    if (prev) prev.classList.remove('highlight');
  }
  // neues setzen
  const el = document.getElementById(`pin-${id}`);
  if (el) {
    el.classList.add('highlight');
    highlightedPinId = id;
  }
}

function clearHighlight() {
  if (!highlightedPinId) return;
  const el = document.getElementById(`pin-${highlightedPinId}`);
  if (el) el.classList.remove('highlight');
  highlightedPinId = null;
}

// (optional) Alias-Auflösung, falls mal "med" statt "MedPoint" übergeben wird
const aliases = { med: 'MedPoint', medpoint: 'MedPoint', 'med point':'MedPoint' };
function resolveId(id) {
  if (!id) return id;
  const key = String(id).toLowerCase();
  return aliases[key] || id;
}



  function render(){
    const chips = document.getElementById('chips'); chips.innerHTML='';
    categories.forEach(c=>{
      const el=document.createElement('button');
      el.className='chip'; el.textContent=tLabel(c);
      el.onclick=()=>renderList(c.areas);
      chips.appendChild(el);
    });
    renderList(categories.flatMap(c=>c.areas));
  }
function renderList(areaIds){
  const list = document.getElementById('list'); 
  list.innerHTML = '';

  areaIds.forEach(id => {
    const data = translations[id]?.[currentLang]; 
    if (!data) return;

    const card = document.createElement('div'); 
    card.className = 'card';
    if (id === lastFocusId) card.classList.add('selected'); // << neu

    const icon = document.createElement('img'); 
    icon.src = `icons/${id}Icon.png`; 
    icon.alt = id; 
    icon.style.width = '52px'; 
    icon.style.height = '52px';

    const body = document.createElement('div');
    const h = document.createElement('h3'); h.textContent = data.title || id;
    const meta = document.createElement('div'); meta.className = 'meta'; meta.innerHTML = data.time || '';
    const txt = document.createElement('div'); txt.className = 'meta'; txt.innerHTML = data.text || '';

    const actions = document.createElement('div'); actions.className = 'actions';
    const btn1 = document.createElement('button'); btn1.className = 'btn'; btn1.textContent = 'Details';
    btn1.onclick = (e) => { e.stopPropagation(); lastFocusId = id; openSheet(id); }; // << gemerkt

    const btn2 = document.createElement('button'); btn2.className = 'btn ghost'; btn2.textContent = 'Auf Karte zeigen';
    btn2.onclick = (e) => { e.stopPropagation(); lastFocusId = id; showMap(id); }; // << neu: direkt mit ID

    actions.append(btn1, btn2);
    body.append(h, meta, txt, actions);
    card.append(icon, body);
    list.appendChild(card);

    // Klick auf die Karte selbst markiert die Auswahl (für späteren Tab-Wechsel auf "Karte")
    card.addEventListener('click', () => {
      lastFocusId = id;
      // optisch updaten
      document.querySelectorAll('.card.selected').forEach(el => el.classList.remove('selected'));
      card.classList.add('selected');
    });
  });
}

  document.querySelectorAll('.pin').forEach(el => {
  el.addEventListener('click', () => {
    const id = el.id.replace('pin-','');
    lastFocusId = id;
    highlightPin(id);
    openSheet(id);
  });
});


  function openSheet(id){
    const d=translations[id]?.[currentLang]; if(!d) return;
    document.getElementById('sTitle').textContent=d.title||id;
    document.getElementById('sTime').innerHTML=d.time||'';
    document.getElementById('sText').innerHTML=d.text||'';
    const links=document.getElementById('sLinks'); links.innerHTML='';
    (d.links||[]).forEach(l=>{
      const a=document.createElement('a'); a.href=l.url; a.target='_blank';
      a.className='btn'; a.textContent=l.text||'Mehr';
      links.appendChild(a);
    });
    document.getElementById('sheet').classList.add('open');
  }
  function closeSheet(){ document.getElementById('sheet').classList.remove('open'); }

  /* ====== Pin-Fokus ====== */
  function focusPin(id, targetScale = 2) {
    const pinEl = document.getElementById(`pin-${id}`);
    if (!pinEl || !panzoomInstance) return;
    fitAndCenter(START_X_PERCENT);
    const wrapRect = wrapEl.getBoundingClientRect();
    const pinRect  = pinEl.getBoundingClientRect();
    const pinCenterX = pinRect.left + pinRect.width/2 - wrapRect.left;
    const pinCenterY = pinRect.top  + pinRect.height/2 - wrapRect.top;
    panzoomInstance.zoomToPoint(targetScale, { clientX: wrapRect.left + pinCenterX, clientY: wrapRect.top + pinCenterY });
    const t = panzoomInstance.getTransform();
    const dx = (wrapRect.width/2  - pinCenterX) * (1 / t.scale);
    const dy = (wrapRect.height/2 - pinCenterY) * (1 / t.scale);
    panzoomInstance.pan(t.x + dx, t.y + dy);
  }

  /* ====== Start ====== */
  render();
  showList(); // immer mit Liste starten
</script>
</body>
</html>


















