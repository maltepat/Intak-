<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TXL Guide</title>
<style>
  :root { --pad: 16px; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, sans-serif; background:#f7f7f8; }

  /* Header */
  .topbar { position:sticky; top:0; z-index:5; display:flex; gap:12px;
    align-items:center; padding:12px var(--pad); background:#fff; border-bottom:1px solid #e6e6e8; }
  .title { font-weight:700; font-size:18px; }
  .lang { margin-left:auto; }

  /* Tabs */
  .tabs { position:sticky; top:56px; z-index:4; display:flex; gap:8px; padding:8px var(--pad);
    background:#fff; border-bottom:1px solid #eee; }
  .tab { flex:1; text-align:center; padding:10px; border-radius:10px; background:#f0f0f2; cursor:pointer; }
  .tab.active { background:#111; color:#fff; }

  /* Kategorie-Chips */
  .chips { display:flex; gap:8px; overflow:auto; padding:10px var(--pad); }
  .chip { white-space:nowrap; padding:8px 12px; border-radius:999px; background:#fff; border:1px solid #e5e5e7; cursor:pointer; }

  /* Liste */
  .list { padding:12px var(--pad) 80px; display:grid; gap:12px; }
  .card { background:#fff; border:1px solid #eee; border-radius:14px; padding:14px; display:grid; grid-template-columns:52px 1fr; gap:12px; }
  .card h3 { margin:0 0 6px; font-size:16px; }
  .meta { color:#555; font-size:13px; }
  .actions { margin-top:8px; display:flex; gap:8px; }
  .btn { padding:10px 12px; border-radius:10px; background:#111; color:#fff; font-size:14px; border:none; cursor:pointer; }
  .btn.ghost { background:#fff; color:#111; border:1px solid #ddd; }

  /* Karte */
  .mapwrap {
    display:none;
    height:calc(100vh - 112px);
    overflow:hidden;
    position:relative;
    background:#000;

    /* wichtig f√ºr Phones */
    touch-action:none;
    overscroll-behavior: contain;
  }
  .mapwrap.active { display:block; }

  /* feste Gr√∂√üe deiner Grafik */
  .map {
    position:relative;
    width:1920px;
    height:1080px;
    touch-action:none;      /* Gesten an Panzoom durchreichen */
    will-change: transform;
  }

  .map-img {
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:fill;        /* 1920x1080 passt exakt in .map */
    display:block;
    user-select:none;
    pointer-events:none;    /* Bild f√§ngt keine Touches ab */
  }

  .pin {
    position:absolute;
    width:64px; height:64px;
    transform:translate(-50%,-50%);
    cursor:pointer;
  }
  .pin img { width:100%; height:100%; }

  /* Bottom Sheet */
  .sheet { position:fixed; left:0; right:0; bottom:-100%; background:#fff; border-radius:16px 16px 0 0;
    box-shadow:0 -10px 30px rgba(0,0,0,.2); padding:16px; transition:bottom .25s ease; z-index:10; max-height:70vh; overflow:auto; }
  .sheet.open { bottom:0; }
  .sheet h3 { margin:0 0 8px; }
  .sheet .meta { margin-bottom:10px; }
  .sheet .close { position:absolute; right:12px; top:12px; font-size:20px; border:none; background:transparent; cursor:pointer; }

/* Mobile: Vollbild-Karte */
@media (max-width: 768px) {
  body.fullscreen-map .topbar,
  body.fullscreen-map .tabs,
  body.fullscreen-map .chips { display:none; }

  body.fullscreen-map { overflow:hidden; }

  body.fullscreen-map .mapwrap {
    position: fixed;
    inset: 0;
    z-index: 9999;
    width: 100vw;
    height: calc(var(--vh, 1vh) * 100); /* H√∂he kommt aus JS */
    display: block !important;
    background: #000;
    touch-action: none;
    overscroll-behavior: contain;
  }

  .exit-fullscreen {
    position: fixed;
    z-index: 10000;
    right: 12px; top: 12px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid #333;
    background: rgba(255,255,255,.9);
    font-weight: 600;
  }
  body:not(.fullscreen-map) .exit-fullscreen { display:none; }
}
</style>
</head>
<body>
  <div class="topbar">
    <div class="title">TXL Guide</div>
    <select class="lang" id="lang" onchange="setLang(this.value)">
      <option value="de">DE</option><option value="en">EN</option>
      <option value="tr">TR</option><option value="uk">UK</option>
      <option value="ru">RU</option><option value="ar">AR</option><option value="fa">FA</option>
    </select>
  </div>

  <div class="tabs">
    <div class="tab active" id="tab-list" onclick="showList()">Liste</div>
    <div class="tab" id="tab-map" onclick="showMap()">Karte</div>
  </div>

  <div class="chips" id="chips"></div>

  <div class="list" id="list"></div>
  
  <div class="mapwrap" id="mapwrap">
    <div class="map" id="map">
      <img src="bilder/TXL Lageplan LAF-vektorisiert_013_HD(1).png" alt="Karte" class="map-img" draggable="false" />

      <!-- Beispiel-Pins -->
      <div class="pin" id="pin-P5" style="top:58%; left:33%;">
        <img src="icons/P5Icon.png" alt="P5"/>
      </div>
      <div class="pin" id="pin-Kruemelecke" style="top:45%; left:60%;">
        <img src="icons/KruemeleckeIcon.png" alt="Kr√ºmelecke"/>
      </div>
    </div>
  </div>

  <button class="exit-fullscreen" id="exitFsBtn" type="button">Zur Liste</button>

  <div class="sheet" id="sheet">
    <button class="close" onclick="closeSheet()">√ó</button>
    <h3 id="sTitle"></h3>
    <div class="meta" id="sTime"></div>
    <div id="sText"></div>
    <div class="actions" id="sLinks"></div>
  </div>

<script src="translations.js"></script>
<script src="https://unpkg.com/@panzoom/panzoom/dist/panzoom.min.js"></script>
<script>
  /* ====== STATE & HELPERS ====== */
  let currentLang = 'de';
  let panzoomInstance = null;

  const MAP_W = 1920, MAP_H = 1080;
  const isMobile = () => window.matchMedia('(max-width: 768px)').matches;

  function tLabel(cat){ return cat.label?.[currentLang] || cat.label?.de || ''; }
  function setLang(l){ currentLang=l; render(); }

  // DOM refs
  const wrapEl = document.getElementById('mapwrap');
  const mapEl  = document.getElementById('map');

  // Fit-Scale f√ºr den aktuellen Viewport
  function getFitScale() {
    const wrapW = wrapEl.clientWidth;
    const wrapH = wrapEl.clientHeight;
    return Math.min(wrapW / MAP_W, wrapH / MAP_H);
  }

  // Karte einpassen & zentrieren (nur wenn Panzoom existiert)
  function fitAndCenter() {
    if (!panzoomInstance) return;
    const fit = getFitScale();
    const wrapW = wrapEl.clientWidth, wrapH = wrapEl.clientHeight;
    const x = (wrapW - MAP_W * fit) / 2;
    const y = (wrapH - MAP_H * fit) / 2;
    panzoomInstance.setTransform({ x, y, scale: fit });
    panzoomInstance.setOptions({ minScale: fit });  // nicht weiter rauszoomen
  }

  // Zwei Frames warten, bis Layout/Fixes greifen
  const nextFrame = (cb) => requestAnimationFrame(()=>requestAnimationFrame(cb));

  /* ====== NAVIGATION ====== */
  function enterMapFullscreen(){ document.body.classList.add('fullscreen-map'); }
  function exitMapFullscreen(){ document.body.classList.remove('fullscreen-map'); }
  document.getElementById('exitFsBtn')?.addEventListener('click', () => {
    showList();
  });

  function showList(){
    document.getElementById('tab-list').classList.add('active');
    document.getElementById('tab-map').classList.remove('active');
    wrapEl.classList.remove('active');
    document.getElementById('list').style.display='grid';
    if (isMobile()) exitMapFullscreen();
  }

// üëá Hilfsfunktionen (einmalig oben im Script platzieren)
function computeFit() {
  const wrap = document.getElementById('mapwrap');
  const wrapW = wrap.clientWidth;
  const wrapH = wrap.clientHeight;
  const MAP_W = 1920, MAP_H = 1080;
  const scale = Math.min(wrapW / MAP_W, wrapH / MAP_H);
  const x = (wrapW - MAP_W * scale) / 2;
  const y = (wrapH - MAP_H * scale) / 2;
  return { scale, x, y };
}
function waitForImage(imgEl, cb) {
  if (!imgEl) return;
  if (imgEl.complete) cb();
  else imgEl.addEventListener('load', cb, { once: true });
}

  // H√∂he des sichtbaren Bereichs setzen (verhindert schwarzen Balken)
function setFullscreenVH() {
  const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
  const vh = h * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}

// Events aktivieren/deaktivieren f√ºr Vollbild
function enableVHWatchers() {
  setFullscreenVH();
  if (window.visualViewport) {
    visualViewport.addEventListener('resize', onVVChange);
    visualViewport.addEventListener('scroll', onVVChange);
  }
  window.addEventListener('orientationchange', onVVChange);
}
function disableVHWatchers() {
  if (window.visualViewport) {
    visualViewport.removeEventListener('resize', onVVChange);
    visualViewport.removeEventListener('scroll', onVVChange);
  }
  window.removeEventListener('orientationchange', onVVChange);
}

  function onVVChange() {
  const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
  wrapEl.style.height = h + 'px'; // Container-H√∂he neu setzen
  setFullscreenVH();
  if (panzoomInstance) {
    requestAnimationFrame(() => {
      const t = panzoomInstance.getTransform();
      const min = panzoomInstance.getOptions().minScale ?? 0;
      if (Math.abs(t.scale - min) < 0.03) fitAndCenter();
    });
  }
}

function showMap(){
  // Tabs / Sichtbarkeit umschalten
  document.getElementById('tab-map').classList.add('active');
  document.getElementById('tab-list').classList.remove('active');
  const wrapEl = document.getElementById('mapwrap');
  wrapEl.classList.add('active');
  document.getElementById('list').style.display = 'none';

  // Mobile: Vollbild aktivieren + H√∂he setzen
  if (isMobile()) {
    enterMapFullscreen();
    setFullscreenVH(); // H√∂he sofort setzen
    wrapEl.offsetHeight; // üîπ Zwangs-Layout-Refresh
    enableVHWatchers();
  }

  const mapEl = document.getElementById('map');
  const mapImgEl = document.querySelector('.map-img');

  // Warten bis das Bild geladen ist und Layout steht
  waitForImage(mapImgEl, () => {
    requestAnimationFrame(() => {
      setFullscreenVH(); // nochmal zur Sicherheit

      const { scale, x, y } = computeFit();

      if (!panzoomInstance) {
        // Panzoom initialisieren
        panzoomInstance = Panzoom(mapEl, {
          maxScale: 4,
          contain: 'outside',
          startScale: scale,
          startX: x,
          startY: y,
          animate: true
        });

        // Desktop: Wheel-Zoom
        wrapEl.addEventListener('wheel', (e) => {
          e.preventDefault();
          panzoomInstance.zoomWithWheel(e);
        }, { passive: false });

        // Neu anpassen bei Gr√∂√üen√§nderung
        const ro = new ResizeObserver(() => {
          const t = panzoomInstance.getTransform();
          const min = panzoomInstance.getOptions().minScale ?? scale;
          if (Math.abs(t.scale - min) < 0.03) {
            const f = computeFit();
            panzoomInstance.setOptions({ minScale: f.scale });
            panzoomInstance.setTransform({ x: f.x, y: f.y, scale: f.scale });
          }
        });
        ro.observe(wrapEl);

      } else {
        // Bereits initialisiert ‚Üí nur anpassen
        panzoomInstance.setOptions({ minScale: scale });
        panzoomInstance.setTransform({ x, y, scale });
      }

      // üîπ Nach 100 ms nochmal nachjustieren
      setTimeout(() => {
        const f2 = computeFit();
        panzoomInstance.setOptions({ minScale: f2.scale });
        panzoomInstance.setTransform({ x: f2.x, y: f2.y, scale: f2.scale });
      }, 100);
    });
  });
}


  /* ====== LISTE & DATEN ====== */
  const categories = [
    { id:'kids', label:{de:'Kinder & Freizeit', en:'Kids & Leisure'}, areas:['P5','Sandburg','Kruemelecke','Q1','Q'] },
    { id:'health', label:{de:'Medizin', en:'Medical'}, areas:['MP','Med'] },
    { id:'services', label:{de:'Service', en:'Services'}, areas:['Post','Kleiderkammer','Infopoint'] }
  ];

  function render(){
    // Chips
    const chips = document.getElementById('chips'); chips.innerHTML='';
    categories.forEach(c=>{
      const el=document.createElement('button');
      el.className='chip'; el.textContent=tLabel(c);
      el.onclick=()=>renderList(c.areas);
      chips.appendChild(el);
    });
    renderList(categories.flatMap(c=>c.areas));
  }

  function renderList(areaIds){
    const list=document.getElementById('list'); list.innerHTML='';
    areaIds.forEach(id=>{
      const data = translations[id]?.[currentLang]; if(!data) return;
      const card=document.createElement('div'); card.className='card';
      const icon=document.createElement('img'); icon.src=`icons/${id}Icon.png`; icon.alt=id; icon.style.width='52px'; icon.style.height='52px';
      const body=document.createElement('div');
      const h=document.createElement('h3'); h.textContent=data.title || id;
      const meta=document.createElement('div'); meta.className='meta'; meta.innerHTML=data.time||'';
      const txt=document.createElement('div'); txt.className='meta'; txt.innerHTML=data.text||'';
      const actions=document.createElement('div'); actions.className='actions';
      const btn1=document.createElement('button'); btn1.className='btn'; btn1.textContent='Details';
      btn1.onclick=()=>openSheet(id);
      const btn2=document.createElement('button'); btn2.className='btn ghost'; btn2.textContent='Auf Karte zeigen';
      btn2.onclick=()=>{ showMap(); focusPin(id); };
      actions.append(btn1, btn2);
      body.append(h, meta, txt, actions);
      card.append(icon, body);
      list.appendChild(card);
    });
  }

  function openSheet(id){
    const d=translations[id]?.[currentLang]; if(!d) return;
    document.getElementById('sTitle').textContent=d.title||id;
    document.getElementById('sTime').innerHTML=d.time||'';
    document.getElementById('sText').innerHTML=d.text||'';
    const links=document.getElementById('sLinks'); links.innerHTML='';
    (d.links||[]).forEach(l=>{
      const a=document.createElement('a'); a.href=l.url; a.target='_blank';
      a.className='btn'; a.textContent=l.text||'Mehr';
      links.appendChild(a);
    });
    document.getElementById('sheet').classList.add('open');
  }
  function closeSheet(){ document.getElementById('sheet').classList.remove('open'); }

  /* ====== Pin-Fokus ====== */
  function focusPin(id, targetScale = 2) {
    const pinEl = document.getElementById(`pin-${id}`);
    if (!pinEl || !panzoomInstance) return;

    // 1) Sicherstellen, dass Basis-Einpassung aktiv ist (falls gerade frisch ge√∂ffnet)
    fitAndCenter();

    const wrapRect = wrapEl.getBoundingClientRect();
    const pinRect  = pinEl.getBoundingClientRect();

    const pinCenterX = pinRect.left + pinRect.width/2 - wrapRect.left;
    const pinCenterY = pinRect.top  + pinRect.height/2 - wrapRect.top;

    // 2) Um den Pin herum zoomen
    panzoomInstance.zoomToPoint(targetScale, {
      clientX: wrapRect.left + pinCenterX,
      clientY: wrapRect.top  + pinCenterY
    });

    // 3) Dann sanft in die Mitte schieben
    const t = panzoomInstance.getTransform();
    const dx = (wrapRect.width/2  - pinCenterX) * (1 / t.scale);
    const dy = (wrapRect.height/2 - pinCenterY) * (1 / t.scale);
    panzoomInstance.pan(t.x + dx, t.y + dy);
  }

  /* ====== Start ====== */
  render();
  // Optional: Mobile startet gleich mit Karte
  if (isMobile()) showList();
</script>
</body>
</html>











